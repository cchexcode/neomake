version: 1.0

env:
  DEFAULT_ENV_VAR: default var
  OVERRIDE_ENV_VAR_0: old e0
  OVERRIDE_ENV_VAR_1: old e1

.cargo-build: &cargo-build
  - cargo build $CARGO_ARGS

chains:
  a:
    matrix:
      - env:
          VALUE: a 0
      - env:
          VALUE: a 1
      - env:
          VALUE: a 2
    tasks:
      - run:
          - printf "$VALUE"
  b:
    pre:
      - a
    matrix:
      - env:
          VALUE: b 0
      - env:
          VALUE: b 1
      - env:
          VALUE: b 2
    tasks:
      - run:
          - printf "$VALUE"
  c:
    pre:
      - b
    tasks:
      - run:
          - printf "c"

  minimal:
    tasks:
      - run:
          - printf "minimal"

  test:
    pre:
      - minimal
    matrix:
      - env:
          OVERRIDE_ENV_VAR_0: new e0
    tasks:
      - env:
          OVERRIDE_ENV_VAR_1: new e1
        run:
          - printf "$DEFAULT_ENV_VAR"
          - sleep 1
          - printf "$OVERRIDE_ENV_VAR_0"
          - sleep 1
          - printf "$OVERRIDE_ENV_VAR_1"
          - sleep 1
          - echo "A"
          - sleep 1
          - echo "B"
          - sleep 1
          - echo "C"
          - sleep 1
          - echo "D"
          - sleep 1
          - |
            echo "+ some"
            sleep 1
            echo "+ multiline"
            sleep 1
            echo "+ command"
            sleep 1
          - printf "{{ args.test }}" # this will require an argument to be passed via '-a args.test="some-argument"'
          - sleep 1
          - unknown-command
          - printf "too far!"

  "app/cli":
    matrix:
      - workdir: ./code/app/cli
        env:
          CARGO_ARGS: ""
      - workdir: ./code/app/cli
        env:
          CARGO_ARGS: "--release"
    tasks:
      - env: {}
        run: *cargo-build
